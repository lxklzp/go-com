# 运维部署说明

## 代码地址
`http://192.168.2.211/phoenix/go-com`

## 接口文档地址
`https://documenter.getpostman.com/view/3858621/2s9YkuYxk8`

## 依赖安装

参考`depend`目录

`mysql`数据库初始化：`depend/mysql/go_com_prod.sql`

`pgsql`数据库初始化：`depend/pgsql/go_com_prod.sql`

## k8s部署

镜像文件名：`go-com-v1.x.x-images.tar`。

### 单节点

将`go-com-app`和`go-com-web`容器部署在同一个`pod`。

## 服务器部署

`go-com`目录就是项目的完整目录，`main_app`对应`go-com-app`，`main_web`对应`go-com-web`。 配置`config/config.yaml`

### 配置目录权限
```
chmod -R 777 /go-com/runtime
```

### 启动应用服务器
```
/go-com/main_app -id=1 -config=config.yaml文件完整路径
/go-com/main_web -id=1 -config=config.yaml文件完整路径
```

### supervisor配置示例
```
[program:go-com-app]
command=/var/data/go-com/main_app -id=1 -config=/var/data/go-com/config/config.yaml
directory=/var/data/go-com                                                                                                                                                                                      
autostart=true
autorestart=true
stderr_logfile=NONE
stdout_logfile=NONE
startsecs=10
startretries=30

[program:go-com-web]
command=/var/data/go-com/main_web -id=1 -config=/var/data/go-com/config/config.yaml
directory=/var/data/go-com                                                                                                                                                                                      
autostart=true
autorestart=true
stderr_logfile=NONE
stdout_logfile=NONE
startsecs=10
startretries=30
```

## 启动

服务唯一编号（在当前服务下的唯一编号，每启动一个服务程序都要配置，最大99）的3种配置方式，优先级按顺序递增：
1. 配置文件`App`->`Id`
2. 服务启动指令`-id=`
3. 环境变量`GO_COM_ID`，用于k8s的StatefulSet方式，可从pod名称（xx-0、xx-1）中提取ID

## 系统管理员
版本号
```
curl --location 'http://192.168.2.70:9080/api/auth-app-v1/version'

curl --location 'http://192.168.2.70:9080/api/auth-web-v1/version'
```
配置信息
```
curl --location 'http://192.168.2.70:9080/api/auth-app-v1/config' \
--header 'manage-token: BUoBmIicplnldhFUwO9Hud9zC60lsENr'

curl --location 'http://192.168.2.70:9080/api/auth-web-v1/config' \
--header 'manage-token: BUoBmIicplnldhFUwO9Hud9zC60lsENr'
```

## mysql同步到pg
```
docker run --rm -it ghcr.io/dimitri/pgloader:latest pgloader mysql://root:mypass@192.168.2.70:3306/robot_server_prod postgresql://postgres:postgres@192.168.2.22:5432/robot_server_prod
```