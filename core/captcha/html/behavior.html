<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <link rel="shortcut icon" type="image/ico" href="/captcha-example/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="/captcha-example/css/gocaptcha.global.css">
    <link rel="stylesheet" type="text/css" href="/captcha-example/css/toastify.css">
    <title>Native App</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            color: #3C3C3C;
            background: #EBF3FB;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .example {
            padding: 40px 0;
        }

        .box{
            margin: 30px;
        }
    </style>
</head>
<body>
<div class="example">
    <div class="box" id="click-wrap"></div>
</div>
<!-- GoCaptcha -->
<script type="text/javascript" src="/captcha-example/js/gocaptcha.global.js"></script>
<!-- Http Request -->
<script src="/captcha-example/js/axios.js"></script>
<!-- Request parameter serialization-->
<script src="/captcha-example/js/qs.js"></script>
<!-- Toast Tip -->
<script src="/captcha-example/js/toastify.js"></script>

<script type="text/javascript">
axios.defaults.baseURL = '/';

function toastSuccess(msg) {
    Toastify({
        text: msg,
        duration: 1000,
        newWindow: true,
        gravity: "top",
        position: "center",
        style: {
            background: "#f0f9eb",
            border: "1px solid #dcf9cc",
            color: "#5eaa2f",
            borderRadius: "6px",
            boxShadow: "1px 1px 10px #e0e0e0",
            padding: "8px 20px"
        },
    }).showToast();
}

function toastError(msg) {
    Toastify({
        text: msg,
        duration: 1000,
        newWindow: true,
        gravity: "top",
        position: "center",
        style: {
            background: "#fef0f0",
            border: "1px solid #fcd6d6",
            color: "#ed4630",
            borderRadius: "6px",
            boxShadow: "1px 1px 10px #e0e0e0",
            padding: "8px 20px"
        },
    }).showToast();
}


// Click Example
;(function (goCaptcha){
    const getDataApi = "/api/auth-app-dev/captcha-behavior";
    const checkDataApi = "/api/auth-app-dev/two-factor-auth";

    const el = document.getElementById("click-wrap");
    const capt = new goCaptcha.Click({
        width: 300,
        height: 220,
        // iconSize: 30,
    });

    var captKey = ''

    capt.mount(el)

    capt.setEvents({
        click(x,  y) {
            console.log('click - ', x, y)
        },
        confirm(dots, reset) {
            confirmEvent(dots)
        },
        refresh() {
            capt.clear()
            requestCaptchaData()
        },
        close() {
            console.log('>>>>> close')
        }
    })

    const requestCaptchaData = function() {
        capt.clear()
        captKey = ''
        axios({
            method: 'post',
            url: getDataApi,
            data: JSON.stringify({}),
            headers: {
                'content-type':'application/json'
            }
        }).then(function(response){
            const data = response.data.data || {};
            capt.setData({
                image: data['master_image_base64'] || '',
                thumb: data['thumb_image_base64'] || '',
            })
            captKey = data['key']
        }).catch((e)=>{
            console.warn(e)
        })
    }

    const confirmEvent = function (dots) {
        const dotArr = []
        for (let i = 0; i < dots.length; i++) {
            const dot = dots[i]
            dotArr.push(dot.x, dot.y)
        }

        axios({
            method: 'post',
            url: checkDataApi,
            data: JSON.stringify({
                type: 2,
                value: dotArr.join(','),
                key: captKey || ''
            }),
            headers: {
                'content-type':'application/json'
            }
        }).then(function (response){
            const data = response.data || {};
            if (data['code'] === 200) {
                toastSuccess(`check data success`)
            } else {
                toastError(`check data failed`)
            }

            setTimeout(() => {
                requestCaptchaData()
            }, 500)
        }).catch((e)=>{
            console.warn(e)
        })
    }

    requestCaptchaData()
})(window.GoCaptcha || {})

</script>
</body>
</html>
